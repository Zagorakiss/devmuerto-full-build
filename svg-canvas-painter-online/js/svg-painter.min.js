"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function piano(t){return 440*Math.pow(PIANO_BASE,t-49)}function group(){var t=document.createElementNS(SVGNS,"g");return Array.prototype.forEach.call(arguments,t.appendChild.bind(t)),t}function svg(){var t=document.createElementNS(SVGNS,"svg");return Array.prototype.forEach.call(arguments,t.appendChild.bind(t)),t}function makeTransform(){var t=Array.prototype.slice.call(arguments),e=t.shift(),n=t.shift(),r=t.map(function(t){return t+n}).join(",");return e+"("+r+")"}function text(t,e){var n=document.createElementNS(SVGNS,"text");return n.appendChild(document.createTextNode(t)),n.setAttr(null,"font-size",e).setAttr(null,"font-family","Verdana").setAttr(null,"color","currentColor")}function transform(){var t=Array.prototype.slice.call(arguments),e=t.shift(),n=t.join(" ");return e instanceof SVGElement?e.setAttr(null,"transform",n):e.style.transform=n,e}function animate(t,e,n){var r=null,o=0,i=1e3/60,a=3*i,l=i/1e3,s=function c(n){if(requestAnimationFrame(c),null!=r){for(o+=n-r;o>=i;)a>o&&t(l,n-r),o-=i;e&&e()}r=n};requestAnimationFrame(s),n&&(window.addEventListener("resize",n,!1),n())}function FCT(t,e){for(var n=0;n<e.changedTouches.length;++n)t.call(this,e.changedTouches[n],e.changedTouches[n].identifier);e.preventDefault()}function E(t,e,n,r){var o;o=t instanceof String||"string"==typeof t?Array.prototype.slice.call(document.querySelectorAll(t)):[t];for(var i=0;i<o.length;++i)t=o[i],r?t.addEventListener(e,FCT.bind(t,n),!1):t.addEventListener(e,n.bind(t),!1);return o}function beginApp(t,e,n,r){function o(t){var e=arguments.length<=1||void 0===arguments[1]?10:arguments[1];10==e&&t.preventDefault();var n={x:t.clientX,y:t.clientY,rx:t.radiusX||1,ry:t.radiusY||1,b:t.buttons};void 0===n.b?n.b=1:n.b>0&&n.rx*n.ry===1&&(n.rx=1.5,n.ry=1.5),F[e]=n}function i(t){var e=arguments.length<=1||void 0===arguments[1]?10:arguments[1];10==e&&t.preventDefault(),delete F[e]}function a(t){h[t.keyCode]=!0,h.shift=t.shiftKey,h.ctrl=t.ctrlKey,h.alt=t.altKey}function l(t){h[t.keyCode]=!1,h.shift=t.shiftKey,h.ctrl=t.ctrlKey,h.alt=t.altKey}var s=null,c=0,u=1e3/60,C=3*u,d=u/1e3,F={},h={},g=function f(n){var r=requestAnimationFrame(f);try{if(null!=s){var o=n-s;for(c+=o;c>=u;)C>c&&t(d,F,h),c-=u;e(o)}}catch(i){throw cancelAnimationFrame(r),i}s=n};E(r,"mousedown",o),E(r,"mousemove",o),E(r,"mouseup",i),E(r,"mouseout",i),E(r,"touchstart",o,!0),E(r,"touchmove",o,!0),E(r,"touchend",i,!0),E(window,"keydown",a),E(window,"keyup",l),E(window,"resize",n),n(),requestAnimationFrame(g)}function findEverything(){return Array.prototype.filter.call(document.querySelectorAll("*"),function(t){return t.id}).reduce(function(t,e){return t[e.id]=e,t},{})}function onKeyCode(t,e,n,r){var o=arguments.length<=4||void 0===arguments[4]?.25:arguments[4];e[n]||(onKeyCode.lastSwitch=onKeyCode.lastSwitch||{},onKeyCode.lastSwitch[n]=0),e[n]&&t-onKeyCode.lastSwitch[n]>=o&&(onKeyCode.lastSwitch[n]=t,r())}function createWorker(t){var e=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];if("function"==typeof t&&(t=t.toString()),e){t=t.trim();var n=t.indexOf("{");t=t.substring(n+1,t.length-1)}var r=new Blob([t],{type:"text/javascript"}),o=URL.createObjectURL(r);return new Worker(o)}function convert(t){var e=ctrls.canv.getBoundingClientRect(),n={x:ctrls.canv.width*((t.x-e.left)/e.width-.5),y:ctrls.canv.height*((t.y-e.top)/e.height-.5)},r=ctrls.snap.checked?parseFloat(ctrls.snapValue.value)*devicePixelRatio:1;return n.x=r*Math.round(n.x/r),n.y=r*Math.round(n.y/r),n}function moveUp(t){if(this.previousSibling){var e=[polygons[t],polygons[t-1]];polygons[t-1]=e[0],polygons[t]=e[1],this.parentNode.insertBefore(this,this.previousSibling)}}function moveDown(t){if(this.nextSibling){var e=[polygons[t],polygons[t+1]];if(polygons[t+1]=e[0],polygons[t]=e[1],this.nextSibling.nextSibling)this.parentNode.insertBefore(this,this.nextSibling.nextSibling);else{var n=this.parentNode;n.removeChild(this),n.appendChild(this)}}}function startNewPolygon(){var t=document.createElement("option");t.appendChild(document.createTextNode("Layer "+layerCounter++));var e=-1,n=-1,r=!1;E(t,"mousedown",function(t){e=t.clientX,n=t.clientY,r=!0}),E(t,"mouseout",function(t){if(r){var o=(t.clientX-e,t.clientY-n),i=this.parentNode.selectedIndex;0>o?moveUp.call(this,i):o>0&&moveDown.call(this,i)}}),E(t,"mouseup",function(t){r=!1}),ctrls.layers.appendChild(t),polygons.push({points:[]}),ctrls.layers.selectedIndex=polygons.length-1}function update(t,e,n){time+=t;var r=polygons[ctrls.layers.selectedIndex],o=clickState;clickState=OFF;for(var i in e){var a=e[i],l=a.rx*a.ry;curPoint=convert(a),ctrls.use3Dtouch.checked?clickState=o!=ON?l>=1.7?ON:l>=1?HOVER:OFF:1.5>=l?OFF:o:l>1&&(clickState=ON)}if(o!=ON&&clickState==ON){navigator.vibrate(25),r.points.push(curPoint);var s=completePolygon(clone(r));s&&saveCurrentPolygon()}else o==ON&&clickState!=ON&&navigator.vibrate(25)}function saveCurrentPolygon(){var t=polygons[ctrls.layers.selectedIndex];t.mirrorX=ctrls.mirrorX.checked,t.mirrorY=ctrls.mirrorY.checked,startNewPolygon()}function completePolygon(t,e){void 0===t.mirrorX&&(t.mirrorX=ctrls.mirrorX.checked,t.mirrorY=ctrls.mirrorY.checked);var n=t.mirrorX?1:-1,r=t.mirrorY?1:-1,o=!1,i=parseFloat(ctrls.snapValue.value);if(e&&curPoint&&t.points.push(clone(curPoint)),1==n||1==r)for(var a=t.points.length-1;a>=0;--a){var l=t.points[a],s={x:n*l.x,y:r*l.y},c=s.x-l.x,u=s.y-l.y,C=Math.sqrt(c*c+u*u);C>i?t.points.push(s):o=!0}return o}function clone(t){return JSON.parse(JSON.stringify(t))}function drawPolygon(t,e,n,r,o){t.lineWidth=o,t.strokeStyle=r,t.fillStyle=n,t.beginPath(),t.moveTo(e[0].x,e[0].y);for(var i=1;i<e.length;++i)t.lineTo(e[i].x,e[i].y);t.closePath(),t.stroke(),t.fill()}function render(){g.save(),g.translate(canv.width/2,canv.height/2),drawBG(),ctrls.rotate.checked&&g.rotate(time);for(var t=0;t<polygons.length;++t){var e=clone(polygons[t]);completePolygon(e,t==ctrls.layers.selectedIndex),e.points.length>0&&drawPolygon(g,e.points,"rgba(255, 255, 255, 0.5)","rgba(0, 0, 0, 0.5)",3*devicePixelRatio)}g.restore()}function resize(){var t=ctrls.canv.getBoundingClientRect();ctrls.canv.width=t.width*devicePixelRatio,ctrls.canv.height=t.height*devicePixelRatio}function drawAxis(t,e,n){g.beginPath();for(var r=(n?ctrls.canv.width:ctrls.canv.height)/2,o=(n?ctrls.canv.height:ctrls.canv.width)/2,i=0;r>i;i+=e)n?(g.moveTo(i,-o),g.lineTo(i,o),g.moveTo(-i,-o),g.lineTo(-i,o)):(g.moveTo(-o,i),g.lineTo(o,i),g.moveTo(-o,-i),g.lineTo(o,-i));g.lineWidth=t*devicePixelRatio,g.stroke()}function drawBG(){g.fillStyle="#69f",g.fillRect(-ctrls.canv.width/2,-ctrls.canv.height/2,ctrls.canv.width,ctrls.canv.height),g.strokeStyle="#ccf",drawAxis(.75,LINE_DIST,!0),drawAxis(2,5*LINE_DIST,!0),drawAxis(5,LINE_DIST*canv.height,!0),drawAxis(.75,LINE_DIST),drawAxis(2,5*LINE_DIST),drawAxis(5,LINE_DIST*canv.width)}function undo(){var t=polygons[ctrls.layers.selectedIndex];t.points.length>0?t.points.pop():polygons.length>1&&(deletePolygon(),undo())}function deletePolygon(){polygons.length>1&&(polygons.splice(ctrls.layers.selectedIndex,1),ctrls.layers.removeChild(ctrls.layers.children[ctrls.layers.selectedIndex]),-1==ctrls.layers.selectedIndex&&(ctrls.layers.selectedIndex=polygons.length-1))}function toggleMenu(){for(var t=this.parentNode.children,e=null,n=2;n<t.length;++n)e=t[n],"none"==e.style.display?e.style.display="":e.style.display="none";if(e){var r="none"==e.style.display;this.fill(r?"rgba(0, 0, 0, 0.5)":"transparent"),this.fg(r?"transparent":"rgba(0, 0, 0, 0.5)"),this.parentNode.style.width=r?"":"100%"}}function save(t){var e=clone(polygons),n=parseFloat(ctrls.scale.value);e.pop();for(var r=0;r<e.length;++r){completePolygon(e[r]),e[r]=e[r].points;for(var o=0;o<e[r].length;++o)e[r][o].x*=n,e[r][o].y*=n}ctrls.output.style.display="block",ctrls.output.value=t(e)}function formatCanvas(t){return drawPolygon.toString()+"\n\nvar polygons = "+JSON.stringify(t)+';\n\nfor(var i = 0; i < polygons.length; ++i){\n  drawPolygon(g, polygons[i], "rgba(255, 255, 255, 0.5)", "rgba(0, 0, 0, 0.5)", 3);\n}'}function formatSVG(t){for(var e=Number.MAX_VALUE,n=Number.MAX_VALUE,r=Number.MIN_VALUE,o=Number.MIN_VALUE,i=[],a=0;a<t.length;++a){for(var l=t[a],s="",c=0;c<l.length;++c){var u=l[c];e=Math.min(e,u.x),n=Math.min(n,u.y),r=Math.max(r,u.x),o=Math.max(o,u.y),s+=0===c?("M"+u.x+" "+u.y).replace(" -","-"):l[c-1].x===u.x?"V"+u.y:l[c-1].y===u.y?"H"+u.x:("L"+u.x+" "+u.y).replace(" -","-")}i.push(s)}var C=r-e,d=o-n,F=i.map(function(t,e){return'<path id="poly'+e+'" class="st0" d="'+t+'Z"/>'}).join("\n  "),h=e+" "+n+" "+C+" "+d;return'<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="'+h+'" width="'+C+'" height="'+d+'">\n  <style type="text/css">\n    .st0{fill:rgba(255, 255, 255, 0.5);stroke:rgba(0, 0, 0, 0.5);stroke-width:3;}\n  </style>\n  '+F+"\n</svg>"}console.clear();var SVGNS="http://www.w3.org/2000/svg",XLINKNS="http://www.w3.org/1999/xlink",TAU=2*Math.PI,SYS_FONTS="-apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif",skins=["#FFDFC4","#F0D5BE","#EECEB3","#E1B899","#E5C298","#FFDCB2","#E5B887","#E5A073","#E79E6D","#DB9065","#CE967C","#C67856","#BA6C49","#A57257","#F0C8C9","#DDA8A0","#B97C6D","#A8756C","#AD6452","#5C3836","#CB8442","#BD723C","#704139","#A3866A","#870400","#710101","#430000","#5B0001","#302E2E"],COLORS=["#000000","#000033","#000066","#000099","#0000CC","#0000FF","#003300","#003333","#003366","#003399","#0033CC","#0033FF","#006600","#006633","#006666","#006699","#0066CC","#0066FF","#009900","#009933","#009966","#009999","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#00FF00","#00FF33","#00FF66","#00FF99","#00FFCC","#00FFFF","#330000","#330033","#330066","#330099","#3300CC","#3300FF","#333300","#333333","#333366","#333399","#3333CC","#3333FF","#336600","#336633","#336666","#336699","#3366CC","#3366FF","#339900","#339933","#339966","#339999","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#33FF00","#33FF33","#33FF66","#33FF99","#33FFCC","#33FFFF","#660000","#660033","#660066","#660099","#6600CC","#6600FF","#663300","#663333","#663366","#663399","#6633CC","#6633FF","#666600","#666633","#666666","#666699","#6666CC","#6666FF","#669900","#669933","#669966","#669999","#6699CC","#6699FF","#66CC00","#66CC33","#66CC66","#66CC99","#66CCCC","#66CCFF","#66FF00","#66FF33","#66FF66","#66FF99","#66FFCC","#66FFFF","#990000","#990033","#990066","#990099","#9900CC","#9900FF","#993300","#993333","#993366","#993399","#9933CC","#9933FF","#996600","#996633","#996666","#996699","#9966CC","#9966FF","#999900","#999933","#999966","#999999","#9999CC","#9999FF","#99CC00","#99CC33","#99CC66","#99CC99","#99CCCC","#99CCFF","#99FF00","#99FF33","#99FF66","#99FF99","#99FFCC","#99FFFF","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC6666","#CC6699","#CC66CC","#CC66FF","#CC9900","#CC9933","#CC9966","#CC9999","#CC99CC","#CC99FF","#CCCC00","#CCCC33","#CCCC66","#CCCC99","#CCCCCC","#CCCCFF","#CCFF00","#CCFF33","#CCFF66","#CCFF99","#CCFFCC","#CCFFFF","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF6666","#FF6699","#FF66CC","#FF66FF","#FF9900","#FF9933","#FF9966","#FF9999","#FF99CC","#FF99FF","#FFCC00","#FFCC33","#FFCC66","#FFCC99","#FFCCCC","#FFCCFF","#FFFF00","#FFFF33","#FFFF66","#FFFF99","#FFFFCC","#FFFFFF"],transparent="transparent",black="#000000",white="#ffffff",PIANO_BASE=Math.pow(2,1/12),audio=window.AudioContext&&new AudioContext,OSCILLATORS=[],IS_IN_GRID=!1,initAudio=null,play=null,noteOn=null,noteOff=null,MAX_NOTE_COUNT=navigator.maxTouchPoints+1;if(audio&&audio.createGain){var out=audio.createGain(),minNote=0;out.connect(audio.destination),initAudio=function(t,e){var n=arguments.length<=2||void 0===arguments[2]?"sawtooth":arguments[2];minNote=t||0;for(var r=0;MAX_NOTE_COUNT>r;++r){var o=audio.createGain();o.gain.value=0;var i=audio.createOscillator();i.type=n,i.frequency.value=0,i.connect(o),i.start(),o.connect(out),OSCILLATORS.push({osc:i,gain:o})}},noteOn=function(t,e){var n=arguments.length<=2||void 0===arguments[2]?0:arguments[2],r=OSCILLATORS[n%OSCILLATORS.length],o=piano(minNote+parseFloat(e)+1);return r.osc.frequency.setValueAtTime(o,0),r.gain.gain.value=parseFloat(t),r},noteOff=noteOn.bind(void 0,0),play=function(t,e,n){var r=arguments.length<=3||void 0===arguments[3]?0:arguments[3];0==OSCILLATORS.length&&initAudio(0,88);var o=noteOn(e,t,r);o&&(o.timeout&&(clearTimeout(o.timeout),o.timeout=null),o.timeout=setTimeout(function(){noteOff(t,r),o.timeout=null},1e3*n))}}else IS_IN_GRID=!0,function(){var t=null;window.requestAnimationFrame=function(e){setTimeout(function(){null==t&&(t=Date.now()),e(Date.now()-t)},16)}}(),initAudio=noteOn=noteOff=play=function(){};Math.randomRange=function(t,e){return Math.random()*(e-t)+t},Math.randomInt=function(t,e){return Math.floor(Math.randomRange(void 0==e?0:t,void 0==e?t:e))},Math.randomSteps=function(t,e,n){return t+Math.randomInt(0,(1+e-t)/n)*n},Array.prototype.random=function(){return this[Math.randomInt(0,this.length)]},SVGElement.prototype.setAttr=function(t,e,n){return this.setAttributeNS(t,e,n),this};var identity=function(){},translate=function(t,e){var n=arguments.length<=2||void 0===arguments[2]?"":arguments[2];return makeTransform("translate",n,t,e)},rotate=function(t){var e=arguments.length<=1||void 0===arguments[1]?"":arguments[1];return makeTransform("rotate",e,t)},scale=function(t,e){return makeTransform("scale","",t,e)},use=function(t){return document.createElementNS(SVGNS,"use").link(t)},rect=function(t,e,n,r){return document.createElementNS(SVGNS,"rect").setAttr(null,"x",t).setAttr(null,"y",e).setAttr(null,"width",n).setAttr(null,"height",r)},path=function(){return document.createElementNS(SVGNS,"path")};SVGElement.prototype.fill=function(t){return this.setAttr(null,"fill",t)},SVGElement.prototype.bg=SVGElement.prototype.fill,SVGElement.prototype.stroke=function(t){return this.setAttr(null,"stroke",t)},SVGElement.prototype.strokeWidth=function(t){return this.setAttr(null,"stroke-width",t)},SVGElement.prototype.fg=function(t){return this.setAttr(null,"color",t)},SVGElement.prototype.link=function(t){return this.setAttr(XLINKNS,"href",t)},SVGElement.prototype.d=function(t){return this.setAttr(null,"d",t)},SVGElement.prototype.ID=function(t){return this.setAttr(null,"id",t)},SVGElement.prototype.trans=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this),transform.apply(window,t)},CanvasRenderingContext2D.prototype.roundedRect=function(t,e,n,r){var o=arguments.length<=4||void 0===arguments[4]?5:arguments[4],i=arguments.length<=5||void 0===arguments[5]?!0:arguments[5],a=arguments.length<=6||void 0===arguments[6]?!1:arguments[6];this.beginPath(),this.moveTo(t+o,e),this.lineTo(t+n-o,e),this.quadraticCurveTo(t+n,e,t+n,e+o),this.lineTo(t+n,e+r-o),this.quadraticCurveTo(t+n,e+r,t+n-o,e+r),this.lineTo(t+o,e+r),this.quadraticCurveTo(t,e+r,t,e+r-o),this.lineTo(t,e+o),this.quadraticCurveTo(t,e,t+o,e),this.closePath(),i&&this.fill(),a&&this.stroke()},CanvasRenderingContext2D.prototype.circle=function(t,e,n){var r=arguments.length<=3||void 0===arguments[3]?!0:arguments[3],o=arguments.length<=4||void 0===arguments[4]?!1:arguments[4];this.beginPath(),this.arc(t,e,n,0,TAU,!1),r&&this.fill(),o&&this.stroke()};var Workerize=function(){function t(e){var n=this;_classCallCheck(this,t);var r=e.toString(),o=r.match(/function (\w+)\(/)[1];for(var i in e.prototype)r+="\n\n"+o+".prototype."+i+" = "+e.prototype[i].toString()+";";r+="\n\n(function(){\n  var instance = new "+o+"();",r+="\n  if(instance.addEventListener){\n    for(var k in instance.listeners) {\n      instance.addEventListener(k, function(){\n        var args = Array.prototype.slice.call(arguments);\n        postMessage(args);\n      }.bind(this, k));\n    }\n  }",r+="\n\n  onmessage = function(evt){\n    var f = evt.data.shift();\n    if(instance[f]){\n      instance[f].apply(instance, evt.data);\n    }\n  }\n\n})();",this.worker=createWorker(r,!1),this.listeners={},this.worker.onmessage=function(t){var e=t.data.shift();n.listeners[e]&&n.listeners[e].forEach(function(e){return e.apply(n,t.data)})};for(var i in e.prototype)"addEventListener"!=i&&(this[i]=function(){var t=Array.prototype.slice.call(arguments);this.worker.postMessage(t)}.bind(this,i))}return t.prototype.addEventListener=function(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)},t}();console.clear();var ctrls=findEverything(),g=ctrls.canv.getContext("2d"),LINE_DIST=10*devicePixelRatio,polygons=[],OFF=0,HOVER=1,ON=2,clickState=OFF,curPoint=void 0,layerCounter=1,time=0;E(ctrls.moveUp,"click",function(){moveUp.call(ctrls.layers.children[ctrls.layers.selectedIndex],ctrls.layers.selectedIndex)}),E(ctrls.moveDown,"click",function(){moveDown.call(ctrls.layers.children[ctrls.layers.selectedIndex],ctrls.layers.selectedIndex)}),startNewPolygon(),E(ctrls.mirrorX,"change",function(t){ctrls.mirrorY.checked&&ctrls.mirrorX.checked&&(ctrls.mirrorY.checked=!1)}),E(ctrls.mirrorY,"change",function(t){ctrls.mirrorY.checked&&ctrls.mirrorX.checked&&(ctrls.mirrorX.checked=!1)}),E(ctrls.undo,"click",undo),E(ctrls.deleteCurrent,"click",deletePolygon),E(".menuControl","click",toggleMenu).forEach(function(t){return toggleMenu.call(t)}),toggleMenu.call(ctrls.layersWindow),E(ctrls.saveCanvas,"click",save.bind(void 0,formatCanvas)),E(ctrls.saveSVG,"click",save.bind(void 0,formatSVG)),E(ctrls.startNew,"click",saveCurrentPolygon),beginApp(update,render,resize,canv);
